{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Rental Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        th {
            /* Disable text selecting */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: pointer;
        }

        .card {
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 200px;
        }

        .fixed-height {
            max-height: 300px;
            min-height: 300px;
            overflow-y: auto;
        }
        .fixed-height-2 {
            max-height: 267px;
            min-height: 267px;
            overflow-y: auto;
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <h3 class="mb-4">Good Afternoon, User!</h3>

        <!-- Row 1 -->
        <div class="row">
           <!-- Outstanding Balances -->
<div class="col-md-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Outstanding Balances</strong>
            <span>Total: ${{ total_outstanding|floatformat:0|intcomma }}</span>
        </div>
        <div class="card-body p-0">
            <!-- Table Header -->
            <table class="table table-sm table-striped mb-0 text-nowrap" style="font-size: 0.85rem;" id="balancesTableHead">
                <thead class="thead-light">
                    <tr>
                        <th onclick="sortTable(0)" class="pl-2" style="width: 35%;">Name</th>
                        <th onclick="sortTable(1)" style="width: 30%;">Unit</th>
                        <th onclick="sortTable(2)" class="pr-4" style="width: 15%; text-align: right;">Days</th>
                        <th onclick="sortTable(3)" class="pr-2" style="width: 15%; text-align: right;">Amount</th>
                    </tr>
                </thead>
            </table>

            <!-- Scrollable Table Body -->
            <div class="fixed-height-2" style="overflow-y: auto; overflow-x: hidden;">
                <table class="table table-sm table-striped mb-0 text-nowrap" style="font-size: 0.85rem;" id="balancesTable">
                    <tbody>
                        {% for lease in outstanding_balances %}
                        <tr>
                            <td class="pl-2">{{ lease.tenant.name }}</td>
                            <td class="pr-4"> {{ lease.unit.property.name }} #{{ lease.unit.number }}</td>
                            <td class="text-right pr-3">{{ lease.outstanding_balance_age_days }}</td>
                            <td class="text-right pr-3">${{ lease.outstanding_balance|floatformat:0|intcomma }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

            <!-- Listings (Vacant vs Occupied) -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Listings</strong>
                    </div>
                    <div class="card-body fixed-height text-center">
                        <div class="chart-container">
                            <canvas id="rentalChart"></canvas>
                        </div>
                        <p class="mt-2">
                            Vacant Units: {{ vacant_count|intcomma }} |
                            Occupied Units: {{ occupied_count|intcomma }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Applications -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Applications</strong>
                    </div>
                    <div class="card-body fixed-height">
                        <ul class="list-group">
                            {% for app in rental_applications %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ app.applicant_name }} ({{ app.unit.property.name }} #{{ app.unit.number }})
                                <span class="badge badge-primary badge-pill">{{ app.get_status_display }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2 -->
        <div class="row">
            <!-- Expiring Leases -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Expiring Leases (Next 30 Days)</strong>
                    </div>
                    <div class="card-body fixed-height">
                        <div class="chart-container">
                            <canvas id="leaseChart"></canvas>
                        </div>
                        <ul class="list-group mt-2">
                            {% for lease in expiring_leases %}
                            <li class="list-group-item">
                                {{ lease.unit.property.name }} - {{ lease.tenant.name }}<br>
                                <small>Ends: {{ lease.end_date }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tasks -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Tasks</strong>
                    </div>
                    <div class="card-body fixed-height">
                        <ul class="list-group">
                            {% for task in tasks %}
                            <li class="list-group-item">
                                <strong>{{ task.title }}</strong><br>
                                <small>Due: {{ task.due_date }} | Status: {{ task.status }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Recent Activity</strong>
                    </div>
                    <div class="card-body fixed-height">
                        <ul class="list-group">
                            {% for activity in recent_activity %}
                            <li class="list-group-item">
                                {{ activity }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Outstanding Balances Table Sorting -->
    <script>
        let sortDirection = {};
    
        function sortTable(colIndex) {
            const table = document.getElementById("balancesTable");
            const headerTable = document.getElementById("balancesTableHead");
            const headers = headerTable.querySelectorAll("th");
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const isNumeric = colIndex >= 2;
    
            // Toggle sort direction
            sortDirection[colIndex] = !sortDirection[colIndex];
            const direction = sortDirection[colIndex] ? 1 : -1;
    
            // Sort rows
            rows.sort((a, b) => {
                let aText = a.cells[colIndex].textContent.trim();
                let bText = b.cells[colIndex].textContent.trim();
    
                if (isNumeric) {
                    aText = aText.replace(/[^\d.-]/g, '');
                    bText = bText.replace(/[^\d.-]/g, '');
                    return direction * (parseFloat(aText) - parseFloat(bText));
                } else {
                    return direction * aText.localeCompare(bText);
                }
            });
    
            // Re-render rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
    
            // Clear all header arrows
            headers.forEach(th => {
                th.textContent = th.textContent.replace(/[\s▲▼]+$/, '');
            });
    
            // Add arrow to active column
            const arrow = direction === 1 ? ' ▲' : ' ▼';
            headers[colIndex].textContent = headers[colIndex].textContent.trim() + arrow;
        }
    </script>


    <!-- Chart.js -->
    <script>
        // Rental Chart
        var ctx1 = document.getElementById('rentalChart').getContext('2d');
        var rentalChart = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Vacant', 'Occupied'],
                datasets: [{
                    data: [{{ vacant_count }}, {{ occupied_count }}],
            backgroundColor: ['#FF6384', '#36A2EB']
        }]
            },
        options: {
            maintainAspectRatio: false,
                responsive: true
        }
        });

        // Lease Expiry Chart
        var ctx2 = document.getElementById('leaseChart').getContext('2d');
        var expiringLabels = [
            {% for lease in expiring_leases %}
        "{{ lease.unit.property.name }}",
            {% endfor %}
        ];
        var leaseChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: expiringLabels,
                datasets: [{
                    label: 'Expiring Leases',
                    data: expiringLabels.map(() => 1),
                    backgroundColor: '#FFCE56'
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    yAxes: [{
                        ticks: {
                            stepSize: 1,
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    </script>
</body>

</html>